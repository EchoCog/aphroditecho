<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Distinction System - Deep Tree Echo</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Navigation styles */
        .dte-navbar {
            background-color: #1a1a2e;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .dte-navbar .container-fluid {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dte-navbar .navbar-brand {
            color: #e74c3c;
            font-weight: 700;
            font-size: 1.5rem;
            text-decoration: none;
        }
        
        .dte-navbar .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .dte-navbar .nav-item {
            margin: 0 10px;
        }
        
        .dte-navbar .nav-link {
            color: #f8f9fa;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .dte-navbar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .dte-navbar .nav-link.active {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Dropdown menu */
        .dte-navbar .dropdown {
            position: relative;
        }
        
        .dte-navbar .dropdown-menu {
            display: none;
            position: absolute;
            background-color: #1a1a2e;
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            padding: 8px 0;
            border: 1px solid #333;
        }
        
        .dte-navbar .dropdown:hover .dropdown-menu {
            display: block;
        }
        
        .dte-navbar .dropdown-item {
            color: #f8f9fa;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
        }
        
        .dte-navbar .dropdown-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        /* Page styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background-color: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: #0f0f1a;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #1e3a8a;
            color: #ffffff;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: #047857;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: #b91c1c;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .result-display {
            background-color: #1e1e30;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        
        .result-display pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            color: #a0a0a0;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .tab-nav-item {
            padding: 10px 20px;
            cursor: pointer;
            color: #a0a0a0;
            border-bottom: 2px solid transparent;
        }
        
        .tab-nav-item.active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .list-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .list-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .list-item:hover {
            background-color: #2a2a40;
        }
        
        .list-item.selected {
            background-color: #1e3a8a;
        }
        
        .metadata {
            color: #6b7280;
            font-size: 0.8em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="dte-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-braces"></i> DTE
            </a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/"><i class="bi bi-house"></i> Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/memory"><i class="bi bi-memory"></i> Memory</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/recursive_distinction"><i class="bi bi-diagram-3"></i> Recursive Distinction</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/console"><i class="bi bi-terminal"></i> Console</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/diagnostics"><i class="bi bi-activity"></i> Diagnostics</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#"><i class="bi bi-grid-3x3-gap"></i> Workspaces</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/architecture_workspace"><i class="bi bi-buildings"></i> Architecture</a></li>
                        <li><a class="dropdown-item" href="/scheduling_workspace"><i class="bi bi-calendar-week"></i> Scheduling</a></li>
                        <li><a class="dropdown-item" href="/diary_workspace"><i class="bi bi-journal-text"></i> Diary</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1>Recursive Distinction System</h1>
        <p>Explore and manipulate recursive structures based on Spencer-Brown's Laws of Form and Lisp's symbolic structures.</p>
        
        <div class="tab-nav">
            <div class="tab-nav-item active" data-tab="distinctions">Distinctions</div>
            <div class="tab-nav-item" data-tab="hypergnn">HyperGNN</div>
            <div class="tab-nav-item" data-tab="nodes">Self-Referential Nodes</div>
        </div>
        
        <!-- Distinctions Tab -->
        <div class="tab-content active" id="distinctions-tab">
            <div class="grid">
                <div class="card">
                    <h2>Distinctions</h2>
                    <div class="form-group">
                        <input type="text" class="form-control" id="distinction-search" placeholder="Search distinctions...">
                    </div>
                    <div class="result-display">
                        <ul class="list-items" id="distinction-list">
                            <!-- List items will be populated dynamically -->
                            <li class="list-item">Loading distinctions...</li>
                        </ul>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <button class="btn" id="refresh-distinctions">Refresh</button>
                        <button class="btn" id="new-distinction">New Distinction</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Distinction Editor</h2>
                    <div class="form-group">
                        <label for="distinction-name">Name</label>
                        <input type="text" class="form-control" id="distinction-name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label for="distinction-expression">Expression</label>
                        <textarea class="form-control" id="distinction-expression" placeholder="Enter expression (e.g., (lambda (x) (* x x)))">()</textarea>
                    </div>
                    <div class="form-group">
                        <label for="distinction-description">Description</label>
                        <textarea class="form-control" id="distinction-description" placeholder="Enter description"></textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" id="save-distinction">Save</button>
                        <button class="btn btn-danger" id="delete-distinction" style="display: none;">Delete</button>
                        <button class="btn" id="evaluate-distinction">Evaluate</button>
                    </div>
                    <div class="form-group">
                        <label for="distinction-result">Evaluation Result</label>
                        <div class="result-display">
                            <pre id="distinction-result">No evaluation yet</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HyperGNN Tab -->
        <div class="tab-content" id="hypergnn-tab">
            <div class="grid">
                <div class="card">
                    <h2>HyperGNN Networks</h2>
                    <div class="form-group">
                        <input type="text" class="form-control" id="hypergnn-search" placeholder="Search networks...">
                    </div>
                    <div class="result-display">
                        <ul class="list-items" id="hypergnn-list">
                            <!-- List items will be populated dynamically -->
                            <li class="list-item">Loading networks...</li>
                        </ul>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <button class="btn" id="refresh-hypergnn">Refresh</button>
                        <button class="btn" id="new-hypergnn">New Network</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Network Editor</h2>
                    <div class="form-group">
                        <label for="hypergnn-name">Name</label>
                        <input type="text" class="form-control" id="hypergnn-name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label for="hypergnn-structure">Structure</label>
                        <textarea class="form-control" id="hypergnn-structure" placeholder="Enter structure JSON">{}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="hypergnn-weights">Weights (optional)</label>
                        <textarea class="form-control" id="hypergnn-weights" placeholder="Enter weights JSON">{}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="hypergnn-parameters">Parameters (optional)</label>
                        <textarea class="form-control" id="hypergnn-parameters" placeholder="Enter parameters JSON">{}</textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" id="save-hypergnn">Save</button>
                        <button class="btn btn-danger" id="delete-hypergnn" style="display: none;">Delete</button>
                    </div>
                    <div class="form-group">
                        <label>Training</label>
                        <div class="form-group">
                            <input type="number" class="form-control" id="hypergnn-epochs" placeholder="Epochs" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control" id="hypergnn-loss" placeholder="Loss" step="0.01" value="0.5">
                        </div>
                        <button class="btn" id="train-hypergnn">Record Training</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Self-Referential Nodes Tab -->
        <div class="tab-content" id="nodes-tab">
            <div class="grid">
                <div class="card">
                    <h2>Self-Referential Nodes</h2>
                    <div class="form-group">
                        <input type="text" class="form-control" id="node-search" placeholder="Search nodes...">
                    </div>
                    <div class="result-display">
                        <ul class="list-items" id="node-list">
                            <!-- List items will be populated dynamically -->
                            <li class="list-item">Loading nodes...</li>
                        </ul>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <button class="btn" id="refresh-nodes">Refresh</button>
                        <button class="btn" id="new-node">New Node</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Node Editor</h2>
                    <div class="form-group">
                        <label for="node-name">Name</label>
                        <input type="text" class="form-control" id="node-name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label for="node-type">Type</label>
                        <select class="form-control" id="node-type">
                            <option value="function">Function</option>
                            <option value="data">Data</option>
                            <option value="combinator">Combinator</option>
                            <option value="operator">Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="node-expression">Expression</label>
                        <textarea class="form-control" id="node-expression" placeholder="Enter expression"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="node-value">Value</label>
                        <textarea class="form-control" id="node-value" placeholder="Enter value"></textarea>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" id="save-node">Save</button>
                        <button class="btn btn-danger" id="delete-node" style="display: none;">Delete</button>
                        <button class="btn" id="evaluate-node">Evaluate</button>
                    </div>
                    <div class="form-group">
                        <label for="node-result">Evaluation Result</label>
                        <div class="result-display">
                            <pre id="node-result">No evaluation yet</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Connections section -->
            <div class="card" style="margin-top: 20px;">
                <h2>Node Connections</h2>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label for="connection-source">Source Node</label>
                            <select class="form-control" id="connection-source">
                                <option value="">Select source node</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="connection-target">Target Node</label>
                            <select class="form-control" id="connection-target">
                                <option value="">Select target node</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="connection-type">Connection Type</label>
                            <select class="form-control" id="connection-type">
                                <option value="default">Default</option>
                                <option value="call">Call</option>
                                <option value="reference">Reference</option>
                                <option value="composition">Composition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="connection-weight">Weight</label>
                            <input type="number" class="form-control" id="connection-weight" value="1.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <button class="btn" id="create-connection">Create Connection</button>
                        </div>
                    </div>
                    <div>
                        <h3>Current Connections</h3>
                        <div class="result-display">
                            <ul class="list-items" id="connection-list">
                                <!-- List items will be populated dynamically -->
                                <li class="list-item">No connections yet</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recursive System Builder -->
            <div class="card" style="margin-top: 20px;">
                <h2>Recursive System Builder</h2>
                <div class="form-group">
                    <label for="system-structure">System Structure (JSON)</label>
                    <textarea class="form-control" id="system-structure" rows="10" placeholder="Enter system structure JSON">
{
  "name": "recursion-example",
  "type": "function",
  "expression": "(lambda (x) (if (= x 0) 1 (* x (self (- x 1)))))",
  "children": [
    {
      "name": "base-case",
      "type": "data",
      "value": 0
    }
  ],
  "connections": [
    {"from": "recursion-example", "to": "base-case", "type": "input"}
  ]
}
                    </textarea>
                </div>
                <div class="form-group">
                    <button class="btn" id="build-system">Build Recursive System</button>
                </div>
                <div class="form-group">
                    <label for="system-result">Result</label>
                    <div class="result-display">
                        <pre id="system-result">No system built yet</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching functionality
        document.querySelectorAll('.tab-nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-nav-item').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        function displayError(error) {
            console.error('Error:', error);
            alert(`Error: ${error.message || error}`);
        }
        
        // Distinctions functionality
        let currentDistinctionId = null;
        
        function loadDistinctions() {
            fetch('/api/distinctions')
                .then(response => response.json())
                .then(distinctions => {
                    const listElement = document.getElementById('distinction-list');
                    if (!distinctions || distinctions.length === 0) {
                        listElement.innerHTML = '<li class="list-item">No distinctions found</li>';
                        return;
                    }
                    
                    listElement.innerHTML = '';
                    distinctions.forEach(distinction => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.setAttribute('data-id', distinction.id);
                        li.innerHTML = `
                            <strong>${distinction.name}</strong>
                            <div class="metadata">Expression: ${distinction.expression}</div>
                            <div class="metadata">Created: ${formatDate(distinction.created_at)}</div>
                        `;
                        
                        li.addEventListener('click', () => loadDistinction(distinction.id));
                        
                        listElement.appendChild(li);
                    });
                })
                .catch(displayError);
        }
        
        function loadDistinction(id) {
            fetch(`/api/distinctions/${id}`)
                .then(response => response.json())
                .then(distinction => {
                    currentDistinctionId = distinction.id;
                    
                    document.getElementById('distinction-name').value = distinction.name;
                    document.getElementById('distinction-expression').value = distinction.expression;
                    document.getElementById('distinction-description').value = distinction.description || '';
                    
                    // Show delete button
                    document.getElementById('delete-distinction').style.display = 'inline-block';
                    
                    // Highlight selected item
                    document.querySelectorAll('#distinction-list .list-item').forEach(item => {
                        item.classList.remove('selected');
                        if (item.getAttribute('data-id') == id) {
                            item.classList.add('selected');
                        }
                    });
                })
                .catch(displayError);
        }
        
        function saveDistinction() {
            const name = document.getElementById('distinction-name').value;
            const expression = document.getElementById('distinction-expression').value;
            const description = document.getElementById('distinction-description').value;
            
            if (!name || !expression) {
                alert('Name and expression are required');
                return;
            }
            
            const distinctionData = {
                name,
                expression,
                description
            };
            
            let url = '/api/distinctions';
            let method = 'POST';
            
            if (currentDistinctionId) {
                url = `/api/distinctions/${currentDistinctionId}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(distinctionData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert(currentDistinctionId ? 'Distinction updated successfully' : 'Distinction created successfully');
                    loadDistinctions();
                    
                    if (!currentDistinctionId) {
                        // If creating a new distinction, load it
                        currentDistinctionId = result.id;
                        document.getElementById('delete-distinction').style.display = 'inline-block';
                    }
                })
                .catch(displayError);
        }
        
        function deleteDistinction() {
            if (!currentDistinctionId) {
                alert('No distinction selected');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this distinction?')) {
                return;
            }
            
            fetch(`/api/distinctions/${currentDistinctionId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert('Distinction deleted successfully');
                    loadDistinctions();
                    
                    // Reset form
                    document.getElementById('distinction-name').value = '';
                    document.getElementById('distinction-expression').value = '()';
                    document.getElementById('distinction-description').value = '';
                    document.getElementById('distinction-result').textContent = 'No evaluation yet';
                    document.getElementById('delete-distinction').style.display = 'none';
                    
                    currentDistinctionId = null;
                })
                .catch(displayError);
        }
        
        function evaluateDistinction() {
            if (!currentDistinctionId) {
                alert('No distinction selected');
                return;
            }
            
            fetch(`/api/distinctions/${currentDistinctionId}/evaluate`)
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    document.getElementById('distinction-result').textContent = 
                        JSON.stringify(result.result, null, 2);
                })
                .catch(displayError);
        }
        
        function newDistinction() {
            currentDistinctionId = null;
            
            document.getElementById('distinction-name').value = '';
            document.getElementById('distinction-expression').value = '()';
            document.getElementById('distinction-description').value = '';
            document.getElementById('distinction-result').textContent = 'No evaluation yet';
            document.getElementById('delete-distinction').style.display = 'none';
            
            // Remove selection from list
            document.querySelectorAll('#distinction-list .list-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        // HyperGNN functionality
        let currentNetworkId = null;
        
        function loadNetworks() {
            fetch('/api/hypergnn')
                .then(response => response.json())
                .then(networks => {
                    const listElement = document.getElementById('hypergnn-list');
                    if (!networks || networks.length === 0) {
                        listElement.innerHTML = '<li class="list-item">No networks found</li>';
                        return;
                    }
                    
                    listElement.innerHTML = '';
                    networks.forEach(network => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.setAttribute('data-id', network.id);
                        li.innerHTML = `
                            <strong>${network.name}</strong>
                            <div class="metadata">Epochs trained: ${network.epochs_trained}</div>
                            <div class="metadata">Created: ${formatDate(network.created_at)}</div>
                        `;
                        
                        li.addEventListener('click', () => loadNetwork(network.id));
                        
                        listElement.appendChild(li);
                    });
                })
                .catch(displayError);
        }
        
        function loadNetwork(id) {
            fetch(`/api/hypergnn/${id}`)
                .then(response => response.json())
                .then(network => {
                    currentNetworkId = network.id;
                    
                    document.getElementById('hypergnn-name').value = network.name;
                    document.getElementById('hypergnn-structure').value = JSON.stringify(network.structure, null, 2);
                    document.getElementById('hypergnn-weights').value = JSON.stringify(network.weights, null, 2);
                    document.getElementById('hypergnn-parameters').value = JSON.stringify(network.parameters, null, 2);
                    
                    // Show delete button
                    document.getElementById('delete-hypergnn').style.display = 'inline-block';
                    
                    // Highlight selected item
                    document.querySelectorAll('#hypergnn-list .list-item').forEach(item => {
                        item.classList.remove('selected');
                        if (item.getAttribute('data-id') == id) {
                            item.classList.add('selected');
                        }
                    });
                })
                .catch(displayError);
        }
        
        function saveNetwork() {
            const name = document.getElementById('hypergnn-name').value;
            let structure, weights, parameters;
            
            try {
                structure = JSON.parse(document.getElementById('hypergnn-structure').value);
                weights = JSON.parse(document.getElementById('hypergnn-weights').value);
                parameters = JSON.parse(document.getElementById('hypergnn-parameters').value);
            } catch (error) {
                alert('Invalid JSON: ' + error.message);
                return;
            }
            
            if (!name) {
                alert('Name is required');
                return;
            }
            
            const networkData = {
                name,
                structure,
                weights,
                parameters
            };
            
            let url = '/api/hypergnn';
            let method = 'POST';
            
            if (currentNetworkId) {
                url = `/api/hypergnn/${currentNetworkId}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(networkData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert(currentNetworkId ? 'Network updated successfully' : 'Network created successfully');
                    loadNetworks();
                    
                    if (!currentNetworkId) {
                        // If creating a new network, load it
                        currentNetworkId = result.id;
                        document.getElementById('delete-hypergnn').style.display = 'inline-block';
                    }
                })
                .catch(displayError);
        }
        
        function deleteNetwork() {
            if (!currentNetworkId) {
                alert('No network selected');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this network?')) {
                return;
            }
            
            fetch(`/api/hypergnn/${currentNetworkId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert('Network deleted successfully');
                    loadNetworks();
                    
                    // Reset form
                    document.getElementById('hypergnn-name').value = '';
                    document.getElementById('hypergnn-structure').value = '{}';
                    document.getElementById('hypergnn-weights').value = '{}';
                    document.getElementById('hypergnn-parameters').value = '{}';
                    document.getElementById('delete-hypergnn').style.display = 'none';
                    
                    currentNetworkId = null;
                })
                .catch(displayError);
        }
        
        function trainNetwork() {
            if (!currentNetworkId) {
                alert('No network selected');
                return;
            }
            
            const epochs = parseInt(document.getElementById('hypergnn-epochs').value) || 1;
            const loss = parseFloat(document.getElementById('hypergnn-loss').value) || 0.5;
            
            fetch(`/api/hypergnn/${currentNetworkId}/train`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ epochs, loss })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert(`Training recorded: ${epochs} epochs, loss: ${loss}`);
                    loadNetworks(); // Refresh to show updated epochs
                })
                .catch(displayError);
        }
        
        function newNetwork() {
            currentNetworkId = null;
            
            document.getElementById('hypergnn-name').value = '';
            document.getElementById('hypergnn-structure').value = '{}';
            document.getElementById('hypergnn-weights').value = '{}';
            document.getElementById('hypergnn-parameters').value = '{}';
            document.getElementById('delete-hypergnn').style.display = 'none';
            
            // Remove selection from list
            document.querySelectorAll('#hypergnn-list .list-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        // Self-referential nodes functionality
        let currentNodeId = null;
        
        function loadNodes() {
            fetch('/api/nodes')
                .then(response => response.json())
                .then(nodes => {
                    const listElement = document.getElementById('node-list');
                    if (!nodes || nodes.length === 0) {
                        listElement.innerHTML = '<li class="list-item">No nodes found</li>';
                        return;
                    }
                    
                    listElement.innerHTML = '';
                    nodes.forEach(node => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.setAttribute('data-id', node.id);
                        li.innerHTML = `
                            <strong>${node.name}</strong>
                            <div class="metadata">Type: ${node.node_type}</div>
                            <div class="metadata">Created: ${formatDate(node.created_at)}</div>
                        `;
                        
                        li.addEventListener('click', () => loadNode(node.id));
                        
                        listElement.appendChild(li);
                    });
                    
                    // Also update connection dropdowns
                    updateConnectionDropdowns();
                })
                .catch(displayError);
        }
        
        function loadNode(id) {
            fetch(`/api/nodes/${id}`)
                .then(response => response.json())
                .then(node => {
                    currentNodeId = node.id;
                    
                    document.getElementById('node-name').value = node.name;
                    document.getElementById('node-type').value = node.node_type;
                    document.getElementById('node-expression').value = node.expression || '';
                    
                    // Format the value nicely
                    let valueStr = '';
                    if (node.value !== null && node.value !== undefined) {
                        if (typeof node.value === 'object') {
                            valueStr = JSON.stringify(node.value, null, 2);
                        } else {
                            valueStr = String(node.value);
                        }
                    }
                    document.getElementById('node-value').value = valueStr;
                    
                    // Show delete button
                    document.getElementById('delete-node').style.display = 'inline-block';
                    
                    // Highlight selected item
                    document.querySelectorAll('#node-list .list-item').forEach(item => {
                        item.classList.remove('selected');
                        if (item.getAttribute('data-id') == id) {
                            item.classList.add('selected');
                        }
                    });
                    
                    // Load connections for this node
                    loadNodeConnections(id);
                })
                .catch(displayError);
        }
        
        function saveNode() {
            const name = document.getElementById('node-name').value;
            const nodeType = document.getElementById('node-type').value;
            const expression = document.getElementById('node-expression').value;
            let value = document.getElementById('node-value').value;
            
            // Try to parse value as JSON
            if (value) {
                try {
                    value = JSON.parse(value);
                } catch (e) {
                    // If not valid JSON, leave as string
                }
            } else {
                value = null;
            }
            
            if (!name || !nodeType) {
                alert('Name and type are required');
                return;
            }
            
            const nodeData = {
                name,
                node_type: nodeType,
                expression: expression || null,
                value
            };
            
            let url = '/api/nodes';
            let method = 'POST';
            
            if (currentNodeId) {
                url = `/api/nodes/${currentNodeId}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nodeData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert(currentNodeId ? 'Node updated successfully' : 'Node created successfully');
                    loadNodes();
                    
                    if (!currentNodeId) {
                        // If creating a new node, load it
                        currentNodeId = result.id;
                        document.getElementById('delete-node').style.display = 'inline-block';
                    }
                })
                .catch(displayError);
        }
        
        function deleteNode() {
            if (!currentNodeId) {
                alert('No node selected');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this node?')) {
                return;
            }
            
            fetch(`/api/nodes/${currentNodeId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert('Node deleted successfully');
                    loadNodes();
                    
                    // Reset form
                    document.getElementById('node-name').value = '';
                    document.getElementById('node-type').value = 'function';
                    document.getElementById('node-expression').value = '';
                    document.getElementById('node-value').value = '';
                    document.getElementById('node-result').textContent = 'No evaluation yet';
                    document.getElementById('delete-node').style.display = 'none';
                    
                    currentNodeId = null;
                })
                .catch(displayError);
        }
        
        function evaluateNode() {
            if (!currentNodeId) {
                alert('No node selected');
                return;
            }
            
            fetch(`/api/nodes/${currentNodeId}/evaluate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ args: [] })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    document.getElementById('node-result').textContent = 
                        JSON.stringify(result.result, null, 2);
                })
                .catch(displayError);
        }
        
        function newNode() {
            currentNodeId = null;
            
            document.getElementById('node-name').value = '';
            document.getElementById('node-type').value = 'function';
            document.getElementById('node-expression').value = '';
            document.getElementById('node-value').value = '';
            document.getElementById('node-result').textContent = 'No evaluation yet';
            document.getElementById('delete-node').style.display = 'none';
            
            // Remove selection from list
            document.querySelectorAll('#node-list .list-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset connections list
            document.getElementById('connection-list').innerHTML = '<li class="list-item">No connections yet</li>';
        }
        
        function updateConnectionDropdowns() {
            fetch('/api/nodes')
                .then(response => response.json())
                .then(nodes => {
                    const sourceSelect = document.getElementById('connection-source');
                    const targetSelect = document.getElementById('connection-target');
                    
                    // Clear existing options except the default one
                    sourceSelect.innerHTML = '<option value="">Select source node</option>';
                    targetSelect.innerHTML = '<option value="">Select target node</option>';
                    
                    nodes.forEach(node => {
                        const sourceOption = document.createElement('option');
                        sourceOption.value = node.id;
                        sourceOption.textContent = `${node.name} (${node.node_type})`;
                        sourceSelect.appendChild(sourceOption);
                        
                        const targetOption = document.createElement('option');
                        targetOption.value = node.id;
                        targetOption.textContent = `${node.name} (${node.node_type})`;
                        targetSelect.appendChild(targetOption);
                    });
                })
                .catch(displayError);
        }
        
        function loadNodeConnections(nodeId) {
            fetch(`/api/nodes/${nodeId}`)
                .then(response => response.json())
                .then(node => {
                    const connectionList = document.getElementById('connection-list');
                    const connections = node.connections || [];
                    
                    if (connections.length === 0) {
                        connectionList.innerHTML = '<li class="list-item">No connections</li>';
                        return;
                    }
                    
                    connectionList.innerHTML = '';
                    connections.forEach(conn => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.setAttribute('data-id', conn.id);
                        li.innerHTML = `
                            <strong>${conn.connection_type}</strong>
                            <div class="metadata">Source: ${node.name}</div>
                            <div class="metadata">Target: ${conn.target_name}</div>
                            <div class="metadata">Weight: ${conn.weight}</div>
                            <button class="btn btn-danger btn-sm delete-connection" data-id="${conn.id}">Delete</button>
                        `;
                        
                        connectionList.appendChild(li);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-connection').forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const connectionId = this.getAttribute('data-id');
                            deleteConnection(connectionId);
                        });
                    });
                })
                .catch(displayError);
        }
        
        function createConnection() {
            const sourceId = document.getElementById('connection-source').value;
            const targetId = document.getElementById('connection-target').value;
            const connectionType = document.getElementById('connection-type').value;
            const weight = parseFloat(document.getElementById('connection-weight').value) || 1.0;
            
            if (!sourceId || !targetId) {
                alert('Source and target nodes are required');
                return;
            }
            
            const connectionData = {
                source_id: sourceId,
                target_id: targetId,
                connection_type: connectionType,
                weight
            };
            
            fetch('/api/connections', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connectionData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert('Connection created successfully');
                    
                    // If we have a current node, reload its connections
                    if (currentNodeId) {
                        loadNodeConnections(currentNodeId);
                    }
                })
                .catch(displayError);
        }
        
        function deleteConnection(connectionId) {
            if (!confirm('Are you sure you want to delete this connection?')) {
                return;
            }
            
            fetch(`/api/connections/${connectionId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    alert('Connection deleted successfully');
                    
                    // Reload connections for current node
                    if (currentNodeId) {
                        loadNodeConnections(currentNodeId);
                    }
                })
                .catch(displayError);
        }
        
        function buildRecursiveSystem() {
            let structure;
            
            try {
                structure = JSON.parse(document.getElementById('system-structure').value);
            } catch (error) {
                alert('Invalid JSON: ' + error.message);
                return;
            }
            
            const systemData = {
                structure
            };
            
            fetch('/api/recursive-system', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(systemData)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    document.getElementById('system-result').textContent = 
                        JSON.stringify(result, null, 2);
                    
                    alert('Recursive system built successfully');
                    loadNodes(); // Refresh the node list
                })
                .catch(displayError);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Distinctions
            loadDistinctions();
            
            document.getElementById('refresh-distinctions').addEventListener('click', loadDistinctions);
            document.getElementById('new-distinction').addEventListener('click', newDistinction);
            document.getElementById('save-distinction').addEventListener('click', saveDistinction);
            document.getElementById('delete-distinction').addEventListener('click', deleteDistinction);
            document.getElementById('evaluate-distinction').addEventListener('click', evaluateDistinction);
            
            // HyperGNN
            loadNetworks();
            
            document.getElementById('refresh-hypergnn').addEventListener('click', loadNetworks);
            document.getElementById('new-hypergnn').addEventListener('click', newNetwork);
            document.getElementById('save-hypergnn').addEventListener('click', saveNetwork);
            document.getElementById('delete-hypergnn').addEventListener('click', deleteNetwork);
            document.getElementById('train-hypergnn').addEventListener('click', trainNetwork);
            
            // Self-referential nodes
            loadNodes();
            
            document.getElementById('refresh-nodes').addEventListener('click', loadNodes);
            document.getElementById('new-node').addEventListener('click', newNode);
            document.getElementById('save-node').addEventListener('click', saveNode);
            document.getElementById('delete-node').addEventListener('click', deleteNode);
            document.getElementById('evaluate-node').addEventListener('click', evaluateNode);
            
            // Connections
            document.getElementById('create-connection').addEventListener('click', createConnection);
            
            // Recursive system
            document.getElementById('build-system').addEventListener('click', buildRecursiveSystem);
        });
    </script>
</body>
</html>